cmake_minimum_required(VERSION 3.20)
project(TestCMake VERSION 1.0.0 LANGUAGES CXX)

# ============================================================================
# –ß–ê–°–¢–¨ 0: –î–ï–¢–ï–ö–¶–ò–Ø GPU –ò CUDA
# ============================================================================

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ GPU
option(ENABLE_CUDA "Enable CUDA support" ON)
option(ENABLE_OPENCL "Enable OpenCL support" OFF)
option(CUDA_ARCH "CUDA architecture (default: auto-detect)" "")

message(STATUS "")
message(STATUS "üéÆ GPU SUPPORT OPTIONS:")
message(STATUS "   ENABLE_CUDA: ${ENABLE_CUDA}")
message(STATUS "   ENABLE_OPENCL: ${ENABLE_OPENCL}")
message(STATUS "")

# –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ CUDA
if(ENABLE_CUDA)
    find_package(CUDA QUIET)
    if(CUDA_FOUND)
        message(STATUS "‚úÖ CUDA –ù–ê–ô–î–ï–ù–ê!")
        message(STATUS "   CUDA Version: ${CUDA_VERSION}")
        message(STATUS "   CUDA Toolkit: ${CUDA_TOOLKIT_ROOT_DIR}")
        message(STATUS "   CUDA Include: ${CUDA_INCLUDE_DIRS}")
        
        # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å GPU –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
        if(CUDA_ARCH STREQUAL "")
            # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            message(STATUS "üîç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ GPU –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã...")
            execute_process(
                COMMAND ${CUDA_TOOLKIT_ROOT_DIR}/extras/demo_suite/deviceQuery
                OUTPUT_VARIABLE CUDA_DEVICE_QUERY
                ERROR_QUIET
            )
            
            # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±
            if(NOT CUDA_DEVICE_QUERY)
                message(STATUS "‚ö†Ô∏è  deviceQuery –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã")
                set(CUDA_ARCH "70;75;80")  # V100, RTX 2080, A100
            else()
                message(STATUS "üìä GPU Info:")
                message(STATUS "${CUDA_DEVICE_QUERY}")
            endif()
        endif()
        
        message(STATUS "   Target CUDA Arch: ${CUDA_ARCH}")
        set(CUDA_ENABLED TRUE)
    else()
        message(STATUS "‚ö†Ô∏è  CUDA –ù–ï –ù–ê–ô–î–ï–ù–ê")
        message(STATUS "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ CUDA Toolkit: https://developer.nvidia.com/cuda-toolkit")
        message(STATUS "   –ò–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ CUDA: -DENABLE_CUDA=OFF")
        set(CUDA_ENABLED FALSE)
    endif()
else()
    message(STATUS "‚è≠Ô∏è  CUDA –æ—Ç–∫–ª—é—á–µ–Ω–∞ (ENABLE_CUDA=OFF)")
    set(CUDA_ENABLED FALSE)
endif()

# –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ OpenCL
if(ENABLE_OPENCL)
    find_package(OpenCL QUIET)
    if(OpenCL_FOUND)
        message(STATUS "‚úÖ OpenCL –ù–ê–ô–î–ï–ù–ê!")
        message(STATUS "   OpenCL Version: ${OpenCL_VERSION_STRING}")
        message(STATUS "   OpenCL Include: ${OpenCL_INCLUDE_DIRS}")
        set(OPENCL_ENABLED TRUE)
    else()
        message(STATUS "‚ö†Ô∏è  OpenCL –ù–ï –ù–ê–ô–î–ï–ù–ê")
        set(OPENCL_ENABLED FALSE)
    endif()
else()
    message(STATUS "‚è≠Ô∏è  OpenCL –æ—Ç–∫–ª—é—á–µ–Ω–∞ (ENABLE_OPENCL=OFF)")
    set(OPENCL_ENABLED FALSE)
endif()

# ============================================================================
# –ß–ê–°–¢–¨ 1: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –û–ü–ï–†–ê–¶–ò–û–ù–ù–û–ô –°–ò–°–¢–ï–ú–´
# ============================================================================

if(WIN32)
    set(IS_WINDOWS TRUE)
    set(IS_LINUX FALSE)
    set(PLATFORM_NAME "Windows")
    message(STATUS "ü™ü –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: WINDOWS")
    
elseif(UNIX AND NOT APPLE)
    set(IS_LINUX TRUE)
    set(IS_WINDOWS FALSE)
    set(PLATFORM_NAME "Linux")
    message(STATUS "üêß –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: LINUX")
    
elseif(APPLE)
    set(IS_LINUX TRUE)
    set(IS_WINDOWS FALSE)
    set(PLATFORM_NAME "macOS")
    message(STATUS "üçé –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: macOS")
    
else()
    message(FATAL_ERROR "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞!")
endif()

# ============================================================================
# –ß–ê–°–¢–¨ 2: –í–ï–†–°–ò–Ø –ò –°–¢–ê–ù–î–ê–†–¢–´ C++
# ============================================================================

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

message(STATUS "C++ Standard: C++17")
message(STATUS "Compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")

# ============================================================================
# –ß–ê–°–¢–¨ 3: –ü–ê–†–ê–ú–ï–¢–†–´ –°–ë–û–†–ö–ò
# ============================================================================

if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release)
endif()

message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")

# ============================================================================
# –ß–ê–°–¢–¨ 4: –ö–û–ú–ü–ò–õ–Ø–¢–û–† –ò –§–õ–ê–ì–ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò
# ============================================================================

if(MSVC)
    # ===== WINDOWS (MSVC –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä) =====
    message(STATUS "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: MSVC (Visual Studio)")
    
    set(CMAKE_CXX_FLAGS_DEBUG "/MDd /Zi /Od /RTC1")
    set(CMAKE_CXX_FLAGS_RELEASE "/MD /O2 /Oi /arch:AVX2 /DNDEBUG")
    
    add_compile_options(
        /W4
        /EHsc
        /permissive-
        /Zc:inline
    )
    
    add_compile_definitions(
        _CRT_SECURE_NO_WARNINGS
        _CRT_NONSTDC_NO_WARNINGS
    )
    
    message(STATUS "Compiler: MSVC ${MSVC_VERSION}")
    message(STATUS "Optimization: /O2 /arch:AVX2")
    
else()
    # ===== LINUX / WSL / macOS (GCC / Clang) =====
    if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
        message(STATUS "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: GCC")
        set(COMPILER_NAME "GCC")
    elseif(CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
        message(STATUS "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: Clang")
        set(COMPILER_NAME "Clang")
    else()
        message(STATUS "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ${CMAKE_CXX_COMPILER_ID}")
        set(COMPILER_NAME "${CMAKE_CXX_COMPILER_ID}")
    endif()
    
    set(CMAKE_CXX_FLAGS_DEBUG "-g -ggdb3 -O0 -Wall -Wextra -Wpedantic")
    set(CMAKE_CXX_FLAGS_RELEASE "-O3 -march=native -mtune=native -Wall")
    
    add_compile_options(
        -Wall
        -Wextra
        -Wpedantic
        -ffast-math
        -funroll-loops
    )
    
    message(STATUS "Compiler: ${COMPILER_NAME}")
    message(STATUS "Optimization: -O3 -march=native")
    
endif()

# ============================================================================
# –ß–ê–°–¢–¨ 5: –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê
# ============================================================================

message(STATUS "")
message(STATUS "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:")
message(STATUS "   Source dir: ${CMAKE_SOURCE_DIR}")
message(STATUS "   Build dir: ${CMAKE_BINARY_DIR}")
message(STATUS "")

set(SOURCES
    src/main.cpp
    src/mylib.cpp
)

set(HEADERS
    include/mylib.h
)

# –î–æ–±–∞–≤–∏—Ç—å CUDA —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞
if(CUDA_ENABLED)
    list(APPEND SOURCES
        src/gpu_kernel.cu
    )
    list(APPEND HEADERS
        include/gpu_kernel.h
    )
    message(STATUS "‚úÖ CUDA –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã")
endif()

# –î–æ–±–∞–≤–∏—Ç—å OpenCL —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞
if(OPENCL_ENABLED)
    list(APPEND SOURCES
        src/opencl_kernel.cpp
    )
    list(APPEND HEADERS
        include/opencl_kernel.h
    )
    message(STATUS "‚úÖ OpenCL –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã")
endif()

# ============================================================================
# –ß–ê–°–¢–¨ 6: –°–û–ó–î–ê–ù–ò–ï –ò–°–ü–û–õ–ù–Ø–ï–ú–û–ì–û –§–ê–ô–õ–ê
# ============================================================================

if(CUDA_ENABLED)
    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CUDA –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
    enable_language(CUDA)
    set(CMAKE_CUDA_STANDARD 17)
    set(CMAKE_CUDA_STANDARD_REQUIRED ON)
    
    add_executable(${PROJECT_NAME} ${SOURCES} ${HEADERS})
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å CUDA –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
    if(NOT CUDA_ARCH STREQUAL "")
        set_target_properties(${PROJECT_NAME} PROPERTIES
            CUDA_ARCHITECTURES ${CUDA_ARCH}
        )
    endif()
    
    message(STATUS "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CUDA –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –¥–ª—è GPU –∫–æ–¥–∞")
else()
    add_executable(${PROJECT_NAME} ${SOURCES} ${HEADERS})
endif()

# –ü–æ–¥–∫–ª—é—á–∏—Ç—å include –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
target_include_directories(${PROJECT_NAME} 
    PRIVATE 
    ${CMAKE_SOURCE_DIR}/include
)

# ============================================================================
# –ß–ê–°–¢–¨ 7: –õ–ò–ù–ö–û–í–ö–ê –ò –ó–ê–í–ò–°–ò–ú–û–°–¢–ò
# ============================================================================

if(NOT MSVC)
    target_link_libraries(${PROJECT_NAME} PRIVATE m)
endif()

# –õ–∏–Ω–∫–æ–≤–∫–∞ CUDA
if(CUDA_ENABLED)
    target_link_libraries(${PROJECT_NAME} PRIVATE ${CUDA_LIBRARIES})
    target_include_directories(${PROJECT_NAME} PRIVATE ${CUDA_INCLUDE_DIRS})
    target_compile_definitions(${PROJECT_NAME} PRIVATE CUDA_ENABLED=1)
    message(STATUS "‚úÖ CUDA –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –ª–∏–Ω–∫–æ–≤–∫—É")
endif()

# –õ–∏–Ω–∫–æ–≤–∫–∞ OpenCL
if(OPENCL_ENABLED)
    target_link_libraries(${PROJECT_NAME} PRIVATE OpenCL::OpenCL)
    target_include_directories(${PROJECT_NAME} PRIVATE ${OpenCL_INCLUDE_DIRS})
    target_compile_definitions(${PROJECT_NAME} PRIVATE OPENCL_ENABLED=1)
    message(STATUS "‚úÖ OpenCL –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –ª–∏–Ω–∫–æ–≤–∫—É")
endif()

# ============================================================================
# –ß–ê–°–¢–¨ 8: –û–ü–¶–ò–ò –ö–û–ú–ü–ò–õ–Ø–¶–ò–ò –î–õ–Ø –¶–ï–õ–ò
# ============================================================================

if(MSVC)
    target_compile_options(${PROJECT_NAME} 
        PRIVATE 
        /arch:AVX2
        /Gy
        /fp:precise
    )
else()
    target_compile_options(${PROJECT_NAME} PRIVATE -march=native)
endif()

# ============================================================================
# –ß–ê–°–¢–¨ 9: –í–´–í–û–î –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –°–ë–û–†–ö–ï
# ============================================================================

message(STATUS "")
message(STATUS "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ:")
message(STATUS "   Platform: ${PLATFORM_NAME}")
message(STATUS "   Compiler: ${CMAKE_CXX_COMPILER}")
message(STATUS "   C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "   Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "   CUDA: ${CUDA_ENABLED}")
message(STATUS "   OpenCL: ${OPENCL_ENABLED}")
message(STATUS "")

# ============================================================================
# –ß–ê–°–¢–¨ 10: –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
# ============================================================================

if(IS_WINDOWS)
    message(STATUS "‚ú® –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–±–æ—Ä–∫–∏ –Ω–∞ Windows:")
    message(STATUS "")
    message(STATUS "   –° CUDA:")
    message(STATUS "   cmake -B build -G \"Visual Studio 17 2022\" -DENABLE_CUDA=ON")
    message(STATUS "   cmake --build build --config Release")
    message(STATUS "")
    message(STATUS "   –ë–µ–∑ CUDA:")
    message(STATUS "   cmake -B build -G \"Visual Studio 17 2022\" -DENABLE_CUDA=OFF")
    message(STATUS "   cmake --build build --config Release")
    message(STATUS "")
else()
    message(STATUS "‚ú® –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–±–æ—Ä–∫–∏ –Ω–∞ Linux/macOS:")
    message(STATUS "")
    message(STATUS "   –° CUDA –∏ Ninja:")
    message(STATUS "   cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_CUDA=ON")
    message(STATUS "   ninja -C build")
    message(STATUS "")
    message(STATUS "   –° OpenCL:")
    message(STATUS "   cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_OPENCL=ON")
    message(STATUS "   ninja -C build")
    message(STATUS "")
    message(STATUS "   –ë–µ–∑ GPU:")
    message(STATUS "   cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_CUDA=OFF")
    message(STATUS "   ninja -C build")
    message(STATUS "")
endif()

# ============================================================================
# –ö–û–ù–ï–¶ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
# ============================================================================

message(STATUS "‚úÖ CMake –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!")
